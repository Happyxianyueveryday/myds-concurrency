## ReadMriteMutex: 读写锁


### 1. 目录

```
rwmutex -- 读优先的读写锁
wrmutex -- 写优先的读写锁
fair_rwmutex -- 读写公平的读写锁
```

### 2. 基本概念

+ 读优先：当前CPU未被抢占或者被写线程抢占时，读线程和写线程公平竞争；但是当当前CPU被读线程占用时，等待队列中的写线程将被延迟执行，而读线程将被优先执行。
+ 写优先：当前CPU未被抢占或者被读线程抢占时，读线程和写线程公平竞争；但是当当前CPU被写线程占用时，等待队列中的读线程将被延迟执行，而写线程将被优先执行。
+ 读写平等：不论当前CPU处于何种状态，等待队列中的读线程和写线程均公平竞争处理器的使用权。

### 3. 实现原理

虽然读写锁本身也可以通过cpp11的条件变量实现，但本处的实现中，出于性能考虑，尽量减少了条件变量的使用，而是直接使用手动操作互斥量的形式。

+ 读优先：实现依赖一个读线程计数器count，一个保证互斥访问读线程计数器的互斥锁count_mut，一个写线程互斥锁write_mut。当读线程进入时，首先互斥地增加读线程的计数器，若当前线程为第一个读线程（增加计数器后计数值为1），则锁定写线程互斥锁write_mut延迟所有排队的写线程；当读线程退出时，首先互斥地减少读线程的计数器，若当前线程为最后一个读线程（减少计数器后计数值为0），则释放写线程互斥锁write_mut恢复写线程堆对CPU的访问权。

+ 写优先：在读写平等的基础上，加上一个写线程计数器write_count，当write_count不为0时可以延迟读线程的执行。

+ 读写平等：在读优先的基础上，增加一个互斥锁seq作为等待队列，到达的读线程或者写线程都需要到这个队列上进行排队，不论读线程还是写线程，先到者先获取CPU的使用权，因此称为读写平等。


### 4. 性质与特点

+ 读优先：读线程一般比较多，极大提高并发性，但写线程有饥饿风险
+ 写优先：解决了读优先中写线程的饥饿风险
+ 读写公平：相对的折中方案
